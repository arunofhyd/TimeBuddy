<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Soft light gray background */
            color: #2d3748; /* Darker text for readability */
        }

        /* Style for calendar grid cells */
        .calendar-day-cell {
            min-height: 100px; /* Ensure cells have enough height */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            justify-content: flex-start;
            padding: 12px; /* Increased padding */
            cursor: pointer;
            border-radius: 8px; /* More rounded corners */
            transition: all 0.2s ease-in-out; /* Smoother transitions */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        .calendar-day-cell.current-month {
            background-color: #ffffff; /* White for current month days */
            border: 1px solid #e2e8f0; /* Light border */
        }
        .calendar-day-cell.other-month {
            background-color: #f8fafc; /* Very light for other months */
            color: #a0aec0; /* Faded text for other months */
            border: 1px solid #edf2f7;
        }
        .calendar-day-cell.has-activity {
            border: 2px solid #3b82f6; /* Updated Blue */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* More prominent shadow */
        }
        .calendar-day-cell.selected-day {
            background-color: #eff6ff; /* Light blue highlight for selected day */
            border: 2px solid #3b82f6; /* Updated Blue */
            transform: translateY(-2px); /* Slight lift */
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .calendar-day-cell:hover {
            background-color: #e2e8f0; /* Hover effect */
            transform: translateY(-1px); /* Slight lift on hover */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .day-number {
            font-weight: 600; /* Semi-bold */
            font-size: 1.2em; /* Slightly larger */
            margin-bottom: 6px;
            color: #2d3748;
        }
        .calendar-day-cell.other-month .day-number {
            color: #a0aec0; /* Faded for other months */
        }
        .calendar-day-cell.is-sunday .day-number {
            color: #ef4444; /* Red color for Sunday numbers */
        }
        .calendar-day-cell.is-today .day-number {
            color: #3b82f6;
            font-weight: 700;
        }

        .activity-indicator {
            width: 10px; /* Slightly larger dot */
            height: 10px;
            background-color: #3b82f6; /* Updated Blue */
            border-radius: 50%;
            margin-top: 6px;
        }

        /* Custom button styles for a more polished look */
        .btn-primary {
            background-color: #3b82f6; /* Updated Blue (Vibrant) */
            color: #ffffff;
            border: 1px solid #3b82f6; /* Updated Blue */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker vibrant blue on hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Light gray */
            color: #4a5568;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-secondary:hover {
            background-color: #cbd5e0; /* Darker gray on hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #e53e3e; /* Red */
            color: #ffffff;
            border: 1px solid #e53e3e;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-danger:hover {
            background-color: #c53030; /* Darker red on hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Icon button specific styles */
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* Smaller padding for icons */
            border-radius: 0.375rem; /* Tailwind rounded-md */
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent; /* Default transparent border */
            color: #4a5568; /* Default icon color */
        }
        .icon-btn:hover {
            background-color: #e2e8f0; /* Light gray on hover */
            border-color: #cbd5e0; /* Subtle border on hover */
        }
        .icon-btn.edit:hover, .icon-btn.save:hover {
            color: #3b82f6; /* Updated Blue */
        }
        .icon-btn.delete:hover {
            color: #e53e3e; /* Red on hover */
        }

        /* Message popup styles */
        #message-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #message-display.show {
            opacity: 1;
            visibility: visible;
        }

        /* Modal backdrop blur */
        .modal-backdrop {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        /* Inline editing specific styles */
        .activity-text-editable, .time-editable {
            min-height: 24px; /* Ensure a minimum height for editing */
            outline: none; /* Remove default outline */
            border-bottom: 1px dashed #a0aec0; /* Subtle dashed border when editable */
            padding-bottom: 2px;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            cursor: text; /* Indicate it's editable */
        }
        .activity-text-editable:focus, .time-editable:focus {
            border-bottom: 1px solid #3b82f6; /* Updated Blue */
            background-color: #f0f8ff; /* Very light blue background on focus */
        }
        .activity-text-editable.editing, .time-editable.editing {
            background-color: #f0f8ff; /* Light blue background when editing */
        }

        /* Drag and Drop styles */
        .daily-activity-table-body tr.dragging {
            opacity: 0.5;
            background-color: #e0f2fe; /* Light blue background for dragged item */
            border: 1px dashed #3b82f6; /* Updated Blue */
        }
        .daily-activity-table-body tr.drag-over-top {
            border-top: 2px solid #3b82f6; /* Updated Blue */
        }
        .daily-activity-table-body tr.drag-over-bottom {
            border-bottom: 2px solid #3b82f6; /* Updated Blue */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 767px) {
            #calendar-view {
                gap: 0.25rem; /* Reduced gap for smaller screens (gap-1) */
            }
            .calendar-day-cell {
                min-height: 70px; /* Flexible height instead of a fixed square */
                padding: 8px; /* More vertical space for content */
                justify-content: flex-start; /* Align content to the top */
            }
            .day-number {
                font-size: 0.875em; /* Smaller font for smaller cells */
                margin-bottom: 2px;
            }
            .activity-indicator {
                width: 6px;
                height: 6px;
                margin-top: 2px;
            }
            /* Adjust padding for table cells on small screens */
            .daily-activity-table-body td {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <div class="w-full max-w-4xl bg-white rounded-xl border border-gray-200 shadow-2xl p-6 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight text-center w-full">
                TimeBuddy
            </h1>
        </div>

        <div id="message-display" class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg shadow-md" role="alert">
            <span id="message-text" class="block sm:inline font-medium"></span>
        </div>

        <div class="flex flex-col space-y-4 mb-8 w-full">
            <div class="flex space-x-4 w-full">
                <button id="month-view-btn" class="w-1/2 px-5 py-3 text-base font-semibold btn-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Month View
                </button>

                <button id="day-view-btn" class="w-1/2 px-5 py-3 text-base font-semibold btn-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Day View
                </button>
            </div>

            <div class="flex items-center justify-between w-full">
                <button id="prev-btn" class="btn-primary rounded-full flex items-center justify-center w-12 h-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 id="current-period-display" class="text-xl font-bold text-gray-800 text-center mx-2 cursor-pointer hover:text-blue-600 transition-colors duration-200">
                    </h2>
                <button id="next-btn" class="btn-primary rounded-full flex items-center justify-center w-12 h-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <button id="today-btn" class="w-full px-5 py-3 text-base font-bold text-gray-700 bg-white border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 hover:bg-gray-50">
                Today
            </button>
            
            <input type="file" id="upload-csv-input" accept=".csv" class="hidden">
        </div>


        <div id="main-content-area" class="w-full">
            <div id="calendar-view" class="grid grid-cols-7 gap-3">
                <div class="py-3 text-center text-sm font-semibold text-red-500 bg-gray-100 border border-gray-200 rounded-lg">Sun</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg">Mon</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg">Tue</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg">Wed</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg">Thu</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg">Fri</div>
                <div class="py-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg">Sat</div>
                </div>

            <div id="daily-view" class="hidden">
                <button id="add-new-slot-btn" class="px-6 py-3 mb-6 btn-primary rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Add New Slot
                    <svg class="inline-block w-5 h-5 ml-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </button>
                <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden shadow-md">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200 w-1/6">Time</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200 w-4/6">Activity</th>
                            <th class="py-3 px-4 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200 w-1/6">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="daily-activity-table-body" class="divide-y divide-gray-200">
                        </tbody>
                </table>
                <p id="no-daily-activities-message" class="text-center text-gray-500 italic mt-6 hidden">No activities recorded for this day.</p>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row gap-4">
                <button id="upload-csv-btn" class="w-full md:w-1/2 px-5 py-3 text-base font-semibold btn-secondary rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12"></path></svg>
                    <span>Upload Data</span>
                </button>
                <button id="download-csv-btn" class="w-full md:w-1/2 px-5 py-3 text-base font-semibold btn-primary rounded-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                     <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span>Download Data</span>
                </button>
            </div>
        </div>
    </div>

    <div id="hourly-prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-xl border border-gray-200 shadow-2xl p-6 md:p-8 w-full max-w-md transform transition-all duration-300 scale-100">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">
                Time to Log Activity!
            </h2>
            <p class="text-lg text-gray-700 mb-4 text-center">
                What did you do in the last hour?
            </p>
            <textarea id="hourly-activity-input" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y min-h-[100px]"></textarea>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="close-hourly-prompt-modal-btn" class="px-5 py-2 btn-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Close
                </button>
                <button id="save-hourly-activity-btn" class="px-5 py-2 btn-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Save
                </button>
            </div>
        </div>
    </div>

    <div id="month-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-xl border border-gray-200 shadow-2xl p-6 md:p-8 w-full max-w-md transform transition-all duration-300 scale-100">
            <div class="flex justify-between items-center mb-6">
                <button id="prev-year-btn" class="p-2 btn-secondary rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" aria-label="Previous Year">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                </button>
                <h3 id="picker-year-display" class="text-2xl font-semibold text-gray-800">2023</h3>
                <button id="next-year-btn" class="p-2 btn-secondary rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" aria-label="Next Year">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M6 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="month-grid" class="grid grid-cols-3 gap-3">
                </div>
            <div class="flex justify-end mt-6">
                <button id="close-month-picker-btn" class="px-5 py-2 btn-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div class="mt-10 text-center text-gray-500 text-xs opacity-80">
        Made with ❤️ by Arun Thomas
    </div>

    <script>
        // Global state variables
        let currentMonth = new Date(); // Tracks the month being viewed in calendar
        let selectedDate = new Date(); // Tracks the currently selected day for daily view
        let currentPromptHour = ''; // The hour for the current prompt (e.g., "08:00")
        let lastPromptedHour = null; // To prevent multiple prompts in the same hour
        let lastPromptedDate = null; // To reset prompted hour daily
        let currentView = 'month'; // 'month' or 'day'
        let editingInlineTimeKey = null; // Stores the time key of the entry being edited inline
        let draggedItem = null; // Stores the row being dragged

        // Month Picker Modal specific state
        let pickerYear = new Date().getFullYear();

        // DOM Elements
        const messageDisplay = document.getElementById('message-display');
        const messageText = document.getElementById('message-text');
        const currentPeriodDisplay = document.getElementById('current-period-display');
        const monthViewBtn = document.getElementById('month-view-btn');
        const dayViewBtn = document.getElementById('day-view-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const todayBtn = document.getElementById('today-btn');
        const calendarView = document.getElementById('calendar-view');
        const dailyView = document.getElementById('daily-view');
        const addNewSlotBtn = document.getElementById('add-new-slot-btn');
        const dailyActivityTableBody = document.getElementById('daily-activity-table-body');
        const noDailyActivitiesMessage = document.getElementById('no-daily-activities-message');
        const hourlyPromptModal = document.getElementById('hourly-prompt-modal');
        const hourlyActivityInput = document.getElementById('hourly-activity-input');
        const saveHourlyActivityBtn = document.getElementById('save-hourly-activity-btn');
        const closeHourlyPromptModalBtn = document.getElementById('close-hourly-prompt-modal-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const uploadCsvBtn = document.getElementById('upload-csv-btn');
        const uploadCsvInput = document.getElementById('upload-csv-input');
        const monthPickerModal = document.getElementById('month-picker-modal');
        const prevYearBtn = document.getElementById('prev-year-btn');
        const nextYearBtn = document.getElementById('next-year-btn');
        const pickerYearDisplay = document.getElementById('picker-year-display');
        const monthGrid = document.getElementById('month-grid');
        const closeMonthPickerBtn = document.getElementById('close-month-picker-btn');


        // --- Helper Functions ---

        function showMessage(msg, type = 'info') {
            messageText.textContent = msg;
            messageDisplay.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700', 'bg-red-100', 'border-red-400', 'text-red-700');
            if (type === 'error') {
                messageDisplay.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else {
                messageDisplay.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            messageDisplay.classList.add('show');
            clearTimeout(messageDisplay.dataset.timeoutId);
            const timeoutId = setTimeout(() => {
                messageDisplay.classList.remove('show');
            }, 2000);
            messageDisplay.dataset.timeoutId = timeoutId;
        }

        function loadActivityDataFromLocalStorage() {
            try {
                const storedData = localStorage.getItem('activityTrackerData');
                const parsedData = storedData ? JSON.parse(storedData) : {};

                for (const dateKey in parsedData) {
                    // Robustness check for malformed data
                    if (typeof parsedData[dateKey] !== 'object' || parsedData[dateKey] === null) {
                        continue;
                    }

                    for (const timeKey in parsedData[dateKey]) {
                        // BUG FIX: Skip the internal _userCleared flag to prevent script crash
                        if (timeKey === '_userCleared') {
                            continue;
                        }

                        if (typeof parsedData[dateKey][timeKey] === 'string') {
                            parsedData[dateKey][timeKey] = {
                                text: parsedData[dateKey][timeKey],
                                order: 0
                            };
                        }
                        if (parsedData[dateKey][timeKey].order === undefined) {
                             parsedData[dateKey][timeKey].order = 0;
                        }
                    }
                }
                return parsedData;
            }
            catch (error) {
                console.error("Error loading data from local storage:", error);
                showMessage("Error: Could not load data from local storage.", 'error');
                return {};
            }
        }

        function saveActivityDataToLocalStorage(data) {
            try {
                localStorage.setItem('activityTrackerData', JSON.stringify(data));
            }
            catch (error) {
                console.error("Error saving data to local storage:", error);
                showMessage("Error: Could not save data to local storage.", 'error');
            }
        }

        function getYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function parseDisplayDateToYYYYMMDD(displayDateStr) {
            const parts = displayDateStr.split(', ');
            if (parts.length < 3) return null;
            const monthDayYear = `${parts[1]} ${parts[2]}`;
            const date = new Date(monthDayYear);
            if (isNaN(date.getTime())) return null;
            return getYYYYMMDD(date);
        }

        // --- Calendar View Functions ---

        function renderCalendar() {
            while (calendarView.children.length > 7) {
                calendarView.removeChild(calendarView.lastChild);
            }
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay();
            const allStoredData = loadActivityDataFromLocalStorage();
            const today = new Date();

            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day-cell', 'other-month');
                calendarView.appendChild(emptyCell);
            }

            for (let day = 1; day <= numDaysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = getYYYYMMDD(date);
                let hasActivity = false;
                if (allStoredData[dateKey]) {
                    const actualActivities = Object.keys(allStoredData[dateKey]).filter(key => key !== '_userCleared');
                    for (const timeKey of actualActivities) {
                        if (allStoredData[dateKey][timeKey].text && allStoredData[dateKey][timeKey].text.trim() !== '') {
                            hasActivity = true;
                            break;
                        }
                    }
                }
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day-cell', 'current-month');
                if (date.getDay() === 0) dayCell.classList.add('is-sunday');
                if (hasActivity) dayCell.classList.add('has-activity');
                if (getYYYYMMDD(date) === getYYYYMMDD(selectedDate) && currentView === 'day') dayCell.classList.add('selected-day');
                if (getYYYYMMDD(date) === getYYYYMMDD(today)) dayCell.classList.add('is-today');
                
                const dayNumberSpan = document.createElement('div');
                dayNumberSpan.classList.add('day-number');
                dayNumberSpan.textContent = day;
                dayCell.appendChild(dayNumberSpan);
                if (hasActivity) dayCell.innerHTML += `<div class="activity-indicator"></div>`;
                
                dayCell.dataset.date = dateKey;
                dayCell.addEventListener('click', () => {
                    selectedDate = date;
                    currentView = 'day';
                    updateView();
                });
                calendarView.appendChild(dayCell);
            }

            const totalCells = firstDayOfWeek + numDaysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('calendar-day-cell', 'other-month');
                calendarView.appendChild(emptyCell);
            }
        }

        // --- Daily View Functions ---

        function renderDailyActivities() {
            dailyActivityTableBody.innerHTML = '';
            const dateKey = getYYYYMMDD(selectedDate);
            const allStoredData = loadActivityDataFromLocalStorage();
            const dailyActivitiesMap = allStoredData[dateKey] || {};
            let dailyActivitiesArray = [];

            const isUserCleared = dailyActivitiesMap._userCleared === true;
            const hasStoredActivities = Object.keys(dailyActivitiesMap).filter(key => key !== '_userCleared').length > 0;
            const isSunday = selectedDate.getDay() === 0;

            if (hasStoredActivities) {
                dailyActivitiesArray = Object.keys(dailyActivitiesMap)
                    .filter(timeKey => timeKey !== '_userCleared')
                    .map(timeKey => ({
                        time: timeKey,
                        text: dailyActivitiesMap[timeKey].text,
                        order: dailyActivitiesMap[timeKey].order
                    }))
                    .sort((a, b) => a.order - b.order);
            } else if (!isUserCleared && !isSunday) {
                // LOGIC FIX: Show default slots but do not save them automatically
                for (let h = 8; h <= 17; h++) {
                    const timeKey = `${h.toString().padStart(2, '0')}:00-${(h + 1).toString().padStart(2, '0')}:00`;
                    dailyActivitiesArray.push({ time: timeKey, text: "", order: h - 8 });
                }
            }

            // Reset inline editing state when re-rendering
            editingInlineTimeKey = null;

            if (dailyActivitiesArray.length > 0) {
                noDailyActivitiesMessage.classList.add('hidden');
                dailyActivitiesArray.forEach(activity => {
                    const { time: timeKey, text } = activity;
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-100', 'transition-colors', 'duration-150');
                    row.setAttribute('draggable', 'true');
                    row.dataset.time = timeKey;

                    const timeCell = document.createElement('td');
                    timeCell.className = 'py-3 px-4 whitespace-nowrap text-sm text-gray-900 border-b border-gray-100 cursor-text time-editable';
                    timeCell.textContent = timeKey;
                    timeCell.dataset.time = timeKey;
                    timeCell.contentEditable = "true";

                    const activityTextCell = document.createElement('td');
                    activityTextCell.className = 'py-3 px-4 text-sm text-gray-900 border-b border-gray-100';
                    const activityTextDiv = document.createElement('div');
                    activityTextDiv.className = 'activity-text-editable';
                    activityTextDiv.textContent = text;
                    activityTextDiv.dataset.time = timeKey;
                    activityTextDiv.contentEditable = "true";
                    activityTextCell.appendChild(activityTextDiv);

                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'py-3 px-4 text-sm border-b border-gray-100 flex space-x-1 justify-center items-center';
                    actionsCell.dataset.time = timeKey;
                    actionsCell.innerHTML = `
                        <button class="icon-btn edit-btn" aria-label="Edit" data-time="${timeKey}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button class="icon-btn delete-btn" aria-label="Delete" data-time="${timeKey}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                    
                    row.append(timeCell, activityTextCell, actionsCell);
                    dailyActivityTableBody.appendChild(row);
                });

                attachDailyActivityEventListeners();
                attachDragAndDropListeners();
            } else {
                noDailyActivitiesMessage.classList.remove('hidden');
            }
        }

        // --- Event Listeners & Action Handlers ---

        function attachDailyActivityEventListeners() {
            document.querySelectorAll('.activity-text-editable, .time-editable').forEach(element => {
                element.removeEventListener('click', handleInlineEditClick);
                element.addEventListener('click', handleInlineEditClick);
                element.removeEventListener('blur', handleInlineEditBlur);
                element.addEventListener('blur', handleInlineEditBlur);
                element.removeEventListener('keydown', handleInlineEditKeydown);
                element.addEventListener('keydown', handleInlineEditKeydown);
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.removeEventListener('click', handleEditButtonClick);
                button.addEventListener('click', handleEditButtonClick);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteButtonClick);
                button.addEventListener('click', handleDeleteButtonClick);
            });
        }

        function handleInlineEditClick(event) {
            const targetElement = event.currentTarget;
            const time = targetElement.dataset.time;
            if (editingInlineTimeKey && editingInlineTimeKey !== time) {
                const previousEditableElement = document.querySelector(`[data-time="${editingInlineTimeKey}"].activity-text-editable, [data-time="${editingInlineTimeKey}"].time-editable`);
                if (previousEditableElement) previousEditableElement.blur();
            }
            targetElement.focus();
            targetElement.classList.add('editing');
            editingInlineTimeKey = time;
            const actionsCell = targetElement.closest('tr').querySelector('td:last-child');
            actionsCell.innerHTML = `
                <button class="icon-btn save-btn" aria-label="Save" data-time="${time}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                <button class="icon-btn delete-btn" aria-label="Delete" data-time="${time}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
            attachInlineActionListeners(time);
        }

        function handleInlineEditBlur(event) {
            const targetElement = event.currentTarget;
            const time = targetElement.dataset.time;
            if (editingInlineTimeKey === time) {
                if (targetElement.classList.contains('time-editable')) {
                    saveInlineTime(time, targetElement.textContent.trim());
                } else {
                    saveInlineActivityText(time, targetElement.textContent.trim());
                }
            }
            targetElement.classList.remove('editing');
        }

        function handleInlineEditKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.currentTarget.blur();
            }
        }

        function handleEditButtonClick(event) {
            const time = event.currentTarget.dataset.time;
            const activityDiv = document.querySelector(`.activity-text-editable[data-time="${time}"]`);
            if (activityDiv) activityDiv.click();
        }

        function handleDeleteButtonClick(event) {
            const time = event.currentTarget.dataset.time;
            deleteActivity(getYYYYMMDD(selectedDate), time);
        }

        function attachInlineActionListeners(timeKey) {
            const actionsCell = document.querySelector(`td[data-time="${timeKey}"]`);
            if (!actionsCell) return;
            actionsCell.querySelector('.save-btn').addEventListener('click', (e) => {
                const time = e.currentTarget.dataset.time;
                document.querySelector(`.activity-text-editable[data-time="${time}"]`)?.blur();
                document.querySelector(`.time-editable[data-time="${time}"]`)?.blur();
            });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => {
                deleteActivity(getYYYYMMDD(selectedDate), e.currentTarget.dataset.time);
            });
        }

        // --- Drag and Drop Functions ---
        function attachDragAndDropListeners() { /* ... unchanged ... */ }
        function handleDragStart(e) { /* ... unchanged ... */ }
        function handleDragOver(e) { /* ... unchanged ... */ }
        function handleDragLeave(e) { /* ... unchanged ... */ }
        function handleDrop(e) { /* ... unchanged ... */ }
        function handleDragEnd(e) { /* ... unchanged ... */ }
        // The D&D handlers above are unchanged, so they are omitted for brevity in this thought process, but included in the final code.
        // Attaching the full, correct handlers from the previous step.
        function attachDragAndDropListeners() {
            const rows = dailyActivityTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.removeEventListener('dragstart', handleDragStart); row.addEventListener('dragstart', handleDragStart);
                row.removeEventListener('dragover', handleDragOver); row.addEventListener('dragover', handleDragOver);
                row.removeEventListener('dragleave', handleDragLeave); row.addEventListener('dragleave', handleDragLeave);
                row.removeEventListener('drop', handleDrop); row.addEventListener('drop', handleDrop);
                row.removeEventListener('dragend', handleDragEnd); row.addEventListener('dragend', handleDragEnd);
            });
        }
        function handleDragStart(e) {
            draggedItem = e.target.closest('tr');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.dataset.time);
            draggedItem.classList.add('dragging');
        }
        function handleDragOver(e) {
            e.preventDefault();
            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow !== draggedItem) {
                dailyActivityTableBody.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(row => row.classList.remove('drag-over-top', 'drag-over-bottom'));
                const rect = targetRow.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                targetRow.classList.add(offsetY < rect.height / 2 ? 'drag-over-top' : 'drag-over-bottom');
            }
        }
        function handleDragLeave(e) { e.target.closest('tr').classList.remove('drag-over-top', 'drag-over-bottom'); }
        function handleDrop(e) {
            e.preventDefault();
            const targetRow = e.target.closest('tr');
            if (!targetRow || targetRow === draggedItem) return;
            const rect = targetRow.getBoundingClientRect();
            const offsetY = e.clientY - rect.top;
            dailyActivityTableBody.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(row => row.classList.remove('drag-over-top', 'drag-over-bottom'));
            if (offsetY < rect.height / 2) {
                dailyActivityTableBody.insertBefore(draggedItem, targetRow);
            } else {
                dailyActivityTableBody.insertBefore(draggedItem, targetRow.nextSibling);
            }
            updateActivityOrderInLocalStorage();
        }
        function handleDragEnd(e) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
            dailyActivityTableBody.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(row => row.classList.remove('drag-over-top', 'drag-over-bottom'));
        }
        function updateActivityOrderInLocalStorage() {
            const dateKey = getYYYYMMDD(selectedDate);
            const allStoredData = loadActivityDataFromLocalStorage();
            let dailyActivitiesMap = allStoredData[dateKey] || {};
            const orderedTimeKeys = Array.from(dailyActivityTableBody.children).map(row => row.dataset.time);
            let newDailyActivitiesMap = {};
            orderedTimeKeys.forEach((timeKey, index) => {
                if (dailyActivitiesMap[timeKey]) {
                    newDailyActivitiesMap[timeKey] = { text: dailyActivitiesMap[timeKey].text, order: index };
                }
            });
            if (dailyActivitiesMap._userCleared) newDailyActivitiesMap._userCleared = true;
            allStoredData[dateKey] = newDailyActivitiesMap;
            saveActivityDataToLocalStorage(allStoredData);
            showMessage("Activities reordered successfully!", 'success');
            renderDailyActivities();
        }

        // --- Core Logic & Data Manipulation ---
        
        function updateView() {
            if (currentView === 'month') {
                monthViewBtn.className = 'w-1/2 px-5 py-3 text-base font-semibold btn-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
                dayViewBtn.className = 'w-1/2 px-5 py-3 text-base font-semibold btn-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
                calendarView.classList.remove('hidden');
                dailyView.classList.add('hidden');
                currentPeriodDisplay.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                currentPeriodDisplay.classList.add('cursor-pointer');
                renderCalendar();
            } else { // day view
                dayViewBtn.className = 'w-1/2 px-5 py-3 text-base font-semibold btn-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
                monthViewBtn.className = 'w-1/2 px-5 py-3 text-base font-semibold btn-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
                dailyView.classList.remove('hidden');
                calendarView.classList.add('hidden');
                currentPeriodDisplay.textContent = formatDateForDisplay(getYYYYMMDD(selectedDate));
                currentPeriodDisplay.classList.remove('cursor-pointer');
                renderDailyActivities();
            }
        }

        function checkTimeAndPrompt() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const hour = now.getHours();
            const minutes = now.getMinutes();
            const currentDateStr = getYYYYMMDD(now);
            if (lastPromptedDate !== currentDateStr) {
                lastPromptedHour = null;
                lastPromptedDate = currentDateStr;
            }
            if (dayOfWeek >= 1 && dayOfWeek <= 5 && hour >= 8 && hour <= 18 && minutes === 0) {
                if (lastPromptedHour !== hour) {
                    currentPromptHour = `${hour.toString().padStart(2, '0')}:00`;
                    showNativeNotification(currentPromptHour);
                    hourlyActivityInput.value = '';
                    hourlyPromptModal.classList.remove('hidden');
                    lastPromptedHour = hour;
                }
            }
        }

        function showNativeNotification() {
            if (!("Notification" in window)) {
                console.warn("This browser does not support desktop notification");
            } else if (Notification.permission === "granted") {
                new Notification("TimeBuddy - Log Activity!", {
                    body: `What did you do in the last hour?`,
                    requireInteraction: true
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("TimeBuddy - Log Activity!", {
                            body: `What did you do in the last hour?`,
                            requireInteraction: true
                        });
                    }
                });
            }
        }

        function saveHourlyActivity() {
            const dateKey = getYYYYMMDD(new Date());
            const activityText = hourlyActivityInput.value.trim();
            if (!activityText) {
                showMessage("Activity cannot be empty.", 'error');
                return;
            }
            const allStoredData = loadActivityDataFromLocalStorage();
            if (!allStoredData[dateKey]) allStoredData[dateKey] = {};
            const promptEndHourInt = parseInt(currentPromptHour.split(':')[0]);
            const activityStartHourInt = promptEndHourInt - 1;
            const targetTimeRangeKey = `${activityStartHourInt.toString().padStart(2, '0')}:00-${promptEndHourInt.toString().padStart(2, '0')}:00`;
            if (allStoredData[dateKey][targetTimeRangeKey]) {
                allStoredData[dateKey][targetTimeRangeKey].text = activityText;
            } else {
                let maxOrder = -1;
                if (Object.keys(allStoredData[dateKey]).length > 0) {
                    maxOrder = Math.max(...Object.values(allStoredData[dateKey]).map(item => item.order));
                }
                allStoredData[dateKey][targetTimeRangeKey] = { text: activityText, order: maxOrder + 1 };
            }
            if (allStoredData[dateKey]._userCleared) delete allStoredData[dateKey]._userCleared;
            saveActivityDataToLocalStorage(allStoredData);
            showMessage("Activity saved successfully!", 'success');
            hourlyPromptModal.classList.add('hidden');
            if (dateKey === getYYYYMMDD(selectedDate)) updateView();
        }

        function saveInlineActivityText(timeKey, newActivityText) {
            const dateKey = getYYYYMMDD(selectedDate);
            const allStoredData = loadActivityDataFromLocalStorage();
            if (!allStoredData[dateKey]) allStoredData[dateKey] = {};
            if (allStoredData[dateKey][timeKey]) {
                allStoredData[dateKey][timeKey].text = newActivityText;
            } else {
                let maxOrder = -1;
                const existingKeys = Object.keys(allStoredData[dateKey]).filter(k => k !== '_userCleared');
                if (existingKeys.length > 0) {
                    maxOrder = Math.max(...Object.values(allStoredData[dateKey]).filter(item => typeof item === 'object').map(item => item.order));
                }
                allStoredData[dateKey][timeKey] = { text: newActivityText, order: maxOrder + 1 };
            }
            if (allStoredData[dateKey]._userCleared) delete allStoredData[dateKey]._userCleared;
            saveActivityDataToLocalStorage(allStoredData);
            showMessage("Activity updated successfully!", 'success');
            editingInlineTimeKey = null;
            updateView();
        }

        function saveInlineTime(oldTimeKey, newTimeKey) { /* ... unchanged ... */ }
        function deleteActivity(dateKey, timeKey) { /* ... unchanged ... */ }
        function downloadCSV() { /* ... unchanged ... */ }
        function handleFileUpload(event) { /* ... unchanged ... */ }
        function parseAndImportCSV(csvContent) { /* ... unchanged ... */ }
        function parseCsvLine(line) { /* ... unchanged ... */ }
        // Full implementation of unchanged functions
        function saveInlineTime(oldTimeKey, newTimeKey) {
            const dateKey = getYYYYMMDD(selectedDate);
            const allStoredData = loadActivityDataFromLocalStorage();
            if (newTimeKey.trim() === '') {
                showMessage("Time cannot be empty.", 'error');
                updateView();
                return;
            }
            if (!allStoredData[dateKey]) allStoredData[dateKey] = {};
            if (allStoredData[dateKey][newTimeKey] && oldTimeKey !== newTimeKey) {
                showMessage(`An activity already exists with the time "${newTimeKey}".`, 'error');
                updateView();
                return;
            }
            const activityEntry = allStoredData[dateKey][oldTimeKey];
            if (activityEntry) {
                delete allStoredData[dateKey][oldTimeKey];
                allStoredData[dateKey][newTimeKey] = activityEntry;
            }
            if (allStoredData[dateKey]._userCleared) delete allStoredData[dateKey]._userCleared;
            saveActivityDataToLocalStorage(allStoredData);
            showMessage("Time updated successfully!", 'success');
            editingInlineTimeKey = null;
            updateView();
        }
        function deleteActivity(dateKey, timeKey) {
            const allStoredData = loadActivityDataFromLocalStorage();
            if (allStoredData[dateKey] && allStoredData[dateKey][timeKey]) {
                delete allStoredData[dateKey][timeKey];
                const hasActualActivities = Object.keys(allStoredData[dateKey]).filter(key => key !== '_userCleared').length > 0;
                if (!hasActualActivities) allStoredData[dateKey] = { _userCleared: true };
                saveActivityDataToLocalStorage(allStoredData);
                showMessage("Activity deleted successfully!", 'success');
                updateView();
            }
        }
        function downloadCSV() {
            const allStoredData = loadActivityDataFromLocalStorage();
            const yearMonth = `${currentMonth.getFullYear()}-${(currentMonth.getMonth() + 1).toString().padStart(2, '0')}`;
            let csvContent = "data:text/csv;charset=utf-8,Date,Time,Activity\n";
            const monthlyActivities = Object.keys(allStoredData).filter(dateKey => dateKey.startsWith(yearMonth));
            let activitiesToExport = [];
            monthlyActivities.forEach(dateKey => {
                const dailyEntries = Object.keys(allStoredData[dateKey])
                    .filter(timeKey => timeKey !== '_userCleared' && allStoredData[dateKey][timeKey].text && allStoredData[dateKey][timeKey].text.trim() !== '')
                    .map(timeKey => ({
                        date: dateKey,
                        time: timeKey,
                        text: allStoredData[dateKey][timeKey].text,
                        order: allStoredData[dateKey][timeKey].order
                    }));
                activitiesToExport = activitiesToExport.concat(dailyEntries);
            });
            if (activitiesToExport.length === 0) {
                showMessage("No activities to export for this month.", 'info');
                return;
            }
            activitiesToExport.sort((a, b) => a.date.localeCompare(b.date) || a.order - b.order);
            activitiesToExport.forEach(entry => {
                const activity = entry.text.replace(/"/g, '""');
                csvContent += `"${formatDateForDisplay(entry.date)}","${entry.time}","${activity}"\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `TimeBuddy_${yearMonth}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage(`Exported activities for ${yearMonth} to CSV!`, 'success');
        }
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => parseAndImportCSV(e.target.result);
            reader.onerror = () => showMessage("Error reading file.", 'error');
            reader.readAsText(file);
        }
        function parseAndImportCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) { showMessage("CSV file is empty.", 'error'); return; }
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            if (headers[0] !== "Date" || headers[1] !== "Time" || headers[2] !== "Activity") { showMessage("Invalid CSV format. Expected headers: Date,Time,Activity", 'error'); return; }
            const importedData = {};
            for (let i = 1; i < lines.length; i++) {
                const row = parseCsvLine(lines[i]);
                if (row.length < 3) continue;
                const [displayDateStr, time, activityText] = row;
                const dateKey = parseDisplayDateToYYYYMMDD(displayDateStr);
                if (!dateKey) { console.warn(`Skipping row due to invalid date format: ${displayDateStr}`); continue; }
                if (!importedData[dateKey]) importedData[dateKey] = {};
                const orderToAssign = importedData[dateKey][time] ? importedData[dateKey][time].order : Object.keys(importedData[dateKey]).length;
                importedData[dateKey][time] = { text: activityText, order: orderToAssign };
            }
            const allExistingData = loadActivityDataFromLocalStorage();
            const mergedData = { ...allExistingData };
            for (const dateKey in importedData) {
                if (!mergedData[dateKey]) mergedData[dateKey] = {};
                for (const timeKey in importedData[dateKey]) {
                    mergedData[dateKey][timeKey] = importedData[dateKey][timeKey];
                }
                let dayActivitiesArray = Object.keys(mergedData[dateKey]).filter(key => key !== '_userCleared').map(timeKey => ({ time: timeKey, ...mergedData[dateKey][timeKey] })).sort((a, b) => a.order - b.order);
                let reorderedDayMap = {};
                dayActivitiesArray.forEach((activity, index) => { reorderedDayMap[activity.time] = { text: activity.text, order: index }; });
                if (mergedData[dateKey]._userCleared) reorderedDayMap._userCleared = true;
                mergedData[dateKey] = reorderedDayMap;
            }
            saveActivityDataToLocalStorage(mergedData);
            showMessage("CSV data imported successfully!", 'success');
            updateView();
        }
        function parseCsvLine(line) {
            const result = [];
            let inQuote = false;
            let currentField = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') { inQuote = !inQuote; if (inQuote && line[i + 1] === '"') { currentField += '"'; i++; } }
                else if (char === ',' && !inQuote) { result.push(currentField.trim()); currentField = ''; }
                else { currentField += char; }
            }
            result.push(currentField.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        // --- Event Listeners & Initialization ---
        
        monthViewBtn.addEventListener('click', () => { currentView = 'month'; updateView(); });
        dayViewBtn.addEventListener('click', () => { currentView = 'day'; updateView(); });
        prevBtn.addEventListener('click', () => {
            if (currentView === 'month') { currentMonth.setMonth(currentMonth.getMonth() - 1); }
            else { selectedDate.setDate(selectedDate.getDate() - 1); }
            updateView();
        });
        nextBtn.addEventListener('click', () => {
            if (currentView === 'month') { currentMonth.setMonth(currentMonth.getMonth() + 1); }
            else { selectedDate.setDate(selectedDate.getDate() + 1); }
            updateView();
        });
        todayBtn.addEventListener('click', () => {
            const today = new Date();
            selectedDate = today;
            currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            currentView = 'month';
            updateView();
        });
        currentPeriodDisplay.addEventListener('click', () => {
            if (currentView === 'month') {
                pickerYear = currentMonth.getFullYear();
                renderMonthPicker();
                monthPickerModal.classList.remove('hidden');
            }
        });
        addNewSlotBtn.addEventListener('click', () => {
            const dateKey = getYYYYMMDD(selectedDate);
            const allStoredData = loadActivityDataFromLocalStorage();
            let newTimeKey = "00:00", counter = 0;
            if (!allStoredData[dateKey]) allStoredData[dateKey] = {};
            while (allStoredData[dateKey][newTimeKey]) newTimeKey = `00:00-${++counter}`;
            let maxOrder = -1;
            const existingKeys = Object.keys(allStoredData[dateKey]).filter(k => k !== '_userCleared');
            if (existingKeys.length > 0) {
                maxOrder = Math.max(...Object.values(allStoredData[dateKey]).filter(item => typeof item === 'object').map(item => item.order));
            }
            allStoredData[dateKey][newTimeKey] = { text: "", order: maxOrder + 1 };
            if (allStoredData[dateKey]._userCleared) delete allStoredData[dateKey]._userCleared;
            saveActivityDataToLocalStorage(allStoredData);
            updateView();
            setTimeout(() => document.querySelector(`.activity-text-editable[data-time="${newTimeKey}"]`)?.click(), 0);
        });
        saveHourlyActivityBtn.addEventListener('click', saveHourlyActivity);
        closeHourlyPromptModalBtn.addEventListener('click', () => hourlyPromptModal.classList.add('hidden'));
        downloadCsvBtn.addEventListener('click', downloadCSV);
        uploadCsvBtn.addEventListener('click', () => uploadCsvInput.click());
        uploadCsvInput.addEventListener('change', handleFileUpload);
        prevYearBtn.addEventListener('click', () => { pickerYear--; renderMonthPicker(); });
        nextYearBtn.addEventListener('click', () => { pickerYear++; renderMonthPicker(); });
        closeMonthPickerBtn.addEventListener('click', () => monthPickerModal.classList.add('hidden'));

        function renderMonthPicker() {
            monthGrid.innerHTML = '';
            pickerYearDisplay.textContent = pickerYear;
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            monthNames.forEach((name, index) => {
                const monthButton = document.createElement('button');
                monthButton.className = 'px-4 py-3 rounded-lg font-medium text-gray-800 bg-gray-100 hover:bg-blue-100 hover:text-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
                monthButton.textContent = name;
                if (pickerYear === currentMonth.getFullYear() && index === currentMonth.getMonth()) {
                    monthButton.classList.remove('bg-gray-100', 'text-gray-800');
                    monthButton.classList.add('bg-blue-500', 'text-white');
                }
                monthButton.addEventListener('click', () => {
                    currentMonth = new Date(pickerYear, index, 1);
                    selectedDate = new Date(pickerYear, index, 1);
                    currentView = 'month';
                    updateView();
                    monthPickerModal.classList.add('hidden');
                });
                monthGrid.appendChild(monthButton);
            });
        }

        window.onload = function() {
            if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
            updateView();
            setInterval(checkTimeAndPrompt, 60 * 1000);
            checkTimeAndPrompt();
        };

    </script>
</body>
</html>
